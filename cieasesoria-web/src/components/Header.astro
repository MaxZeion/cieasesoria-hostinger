---
import {
    useTranslations,
    getLocalizedPath,
    languageInfo,
    locales,
    type Locale,
} from "../i18n";

interface Props {
    theme?: "light" | "dark";
    lang?: Locale;
}

const { theme = "light", lang = "es" } = Astro.props;
const t = useTranslations(lang);

// Get the current path without locale prefix for language switching
const currentPath = Astro.url.pathname;
const pathWithoutLocale = currentPath.replace(/^\/(en|de)/, "") || "/";
---

<header
    id="main-header"
    class="fixed top-0 left-0 w-full z-50 transition-all duration-300 py-4 px-6 md:px-12"
>
    <div class="max-w-[1400px] mx-auto flex justify-between items-center">
        <!-- Logo -->
        <a href={getLocalizedPath("/", lang)} class="z-50 relative">
            <img
                id="header-logo"
                src="/assets/white-logo-no-background.svg"
                alt="CIE Asesoría"
                width="56"
                height="40"
                class="h-10 w-auto transition-all duration-300"
            />
        </a>

        <!-- Desktop Navigation -->
        <nav class="hidden md:flex items-center gap-8">
            <a
                href={getLocalizedPath("/#servicios", lang)}
                class="nav-link text-white/90 hover:text-white font-medium transition-colors"
                >{t.nav.services}</a
            >
            <a
                href={getLocalizedPath("/#nosotros", lang)}
                class="nav-link text-white/90 hover:text-white font-medium transition-colors"
                >{t.nav.about}</a
            >
            <!-- Noticias temporalmente ocultas
            <a
                href={getLocalizedPath("/news", lang)}
                class="nav-link text-white/90 hover:text-white font-medium transition-colors"
                >{t.nav.news}</a
            >
            -->

            <!-- Language Selector -->
            <div class="relative" id="lang-dropdown">
                <button
                    type="button"
                    id="lang-btn"
                    class="flex items-center gap-2 text-white/90 hover:text-white font-medium transition-colors px-3 py-1.5 rounded-lg hover:bg-white/10"
                    aria-label={t.languages.select}
                    aria-expanded="false"
                    aria-haspopup="true"
                >
                    <span class="text-lg">{languageInfo[lang].flag}</span>
                    <span class="text-sm uppercase">{lang}</span>
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="transition-transform duration-200"
                        id="lang-chevron"
                    >
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
                <div
                    id="lang-menu"
                    class="absolute right-0 top-full mt-2 bg-white rounded-lg shadow-xl border border-gray-100 py-1 min-w-[140px] opacity-0 invisible transform -translate-y-2 transition-all duration-200"
                    role="menu"
                >
                    {
                        locales.map((locale) => (
                            <a
                                href={getLocalizedPath(
                                    pathWithoutLocale,
                                    locale,
                                )}
                                class={`flex items-center gap-3 px-4 py-2.5 text-sm hover:bg-gray-50 transition-colors ${locale === lang ? "text-brand font-bold bg-brand/5" : "text-gray-700"}`}
                                role="menuitem"
                            >
                                <span class="text-lg">
                                    {languageInfo[locale].flag}
                                </span>
                                <span>{languageInfo[locale].name}</span>
                            </a>
                        ))
                    }
                </div>
            </div>

            <a
                href={getLocalizedPath("/#contacto", lang)}
                class="px-5 py-2 bg-white text-brand-dark font-bold rounded-full hover:bg-white/90 transition-all shadow-md"
            >
                {t.nav.contact}
            </a>
        </nav>

        <!-- Mobile Menu Button -->
        <button
            id="mobile-menu-btn"
            class="md:hidden z-50 text-white p-2"
            aria-label={t.header.openMenu}
            aria-expanded="false"
            aria-controls="mobile-menu"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="lucide lucide-menu"
                ><line x1="4" x2="20" y1="12" y2="12"></line><line
                    x1="4"
                    x2="20"
                    y1="6"
                    y2="6"></line><line x1="4" x2="20" y1="18" y2="18"
                ></line></svg
            >
        </button>
    </div>

    <!-- Mobile Menu Overlay -->
    <div
        id="mobile-menu"
        role="dialog"
        aria-label="Menú de navegación"
        class="fixed inset-0 bg-brand-dark/95 backdrop-blur-md z-40 transform translate-x-full transition-transform duration-300 md:hidden flex flex-col justify-center items-center"
    >
        <nav class="flex flex-col gap-8 text-center text-white text-xl">
            <a
                href={getLocalizedPath("/#servicios", lang)}
                class="mobile-link hover:text-brand-light">{t.nav.services}</a
            >
            <a
                href={getLocalizedPath("/#nosotros", lang)}
                class="mobile-link hover:text-brand-light">{t.nav.about}</a
            >
            <!-- Noticias temporalmente ocultas
            <a href={getLocalizedPath("/news", lang)} class="mobile-link hover:text-brand-light"
                >{t.nav.news}</a
            >
            -->
            <a
                href={getLocalizedPath("/#contacto", lang)}
                class="mobile-link px-6 py-2 bg-white text-brand-dark font-bold rounded-full"
                >{t.nav.contact}</a
            >
        </nav>

        <!-- Mobile Language Selector -->
        <div class="mt-12 flex gap-4">
            {
                locales.map((locale) => (
                    <a
                        href={getLocalizedPath(pathWithoutLocale, locale)}
                        class={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${locale === lang ? "bg-white text-brand-dark font-bold" : "bg-white/10 text-white hover:bg-white/20"}`}
                    >
                        <span class="text-lg">{languageInfo[locale].flag}</span>
                        <span class="text-sm uppercase">{locale}</span>
                    </a>
                ))
            }
        </div>
    </div>
</header>

<style>
    /* Scrolled state */
    header.scrolled {
        @apply bg-white/95 backdrop-blur shadow-sm py-3;
    }

    header.scrolled #header-logo {
        filter: invert(1) brightness(0.5) sepia(1) hue-rotate(200deg)
            saturate(3);
    }

    header.scrolled .nav-link {
        @apply text-gray-700 hover:text-brand;
    }

    header.scrolled #lang-btn {
        @apply text-gray-700 hover:text-brand hover:bg-gray-100;
    }

    /* Home Page Logic: Logo hidden initially */
    :global(body.is-home) #header-logo {
        opacity: 0;
        pointer-events: none; /* Prevent clicks when hidden */
    }
    :global(body.is-home) header.past-hero #header-logo {
        opacity: 1;
        pointer-events: auto;
    }

    /* Non-Home Pages: Logo always visible (unless we want specific logic, but default to visible) */
    :global(body:not(.is-home)) #header-logo {
        opacity: 1;
    }

    /* Theme overrides for non-scrolled header on light pages */
    :global(body.theme-light) header:not(.scrolled) .nav-link {
        @apply text-gray-700 hover:text-brand;
    }
    :global(body.theme-light) header:not(.scrolled) #header-logo {
        filter: invert(1) brightness(0.5) sepia(1) hue-rotate(200deg)
            saturate(3);
    }
    :global(body.theme-light) header:not(.scrolled) #mobile-menu-btn {
        @apply text-gray-800;
    }
    :global(body.theme-light) header:not(.scrolled) #lang-btn {
        @apply text-gray-700;
    }

    /* Language dropdown open state */
    #lang-menu.open {
        @apply opacity-100 visible translate-y-0;
    }

    #lang-chevron.open {
        @apply rotate-180;
    }
</style>

<script>
    const header = document.getElementById("main-header");
    const logo = document.getElementById("header-logo") as HTMLImageElement;
    const mobileBtn = document.getElementById("mobile-menu-btn");
    const mobileMenu = document.getElementById("mobile-menu");
    const mobileLinks = document.querySelectorAll(".mobile-link");

    // Language dropdown
    const langBtn = document.getElementById("lang-btn");
    const langMenu = document.getElementById("lang-menu");
    const langChevron = document.getElementById("lang-chevron");

    // Check if we are on home (simple check, or rely on body class added by layout/page)
    const isHome = document.body.classList.contains("is-home");

    function updateHeader() {
        const scrollY = window.scrollY;
        const viewportHeight = window.innerHeight;

        // 1. Bg background logic
        if (scrollY > 20) {
            header?.classList.add("scrolled");
        } else {
            header?.classList.remove("scrolled");
        }

        // 2. Home Logo Logic: Show only after passing Hero (approx 1 viewport)
        // We use a slightly smaller threshold (0.9) to make it appear just as we leave the hero
        if (isHome) {
            if (scrollY > viewportHeight * 0.9) {
                header?.classList.add("past-hero");
            } else {
                header?.classList.remove("past-hero");
            }
        }
    }

    window.addEventListener("scroll", updateHeader);
    window.addEventListener("resize", updateHeader); // Update calculation on resize

    // Mobile Menu
    mobileBtn?.addEventListener("click", () => {
        const isOpen = mobileMenu?.classList.toggle("translate-x-full");
        document.body.classList.toggle("overflow-hidden");
        // Update aria-expanded for accessibility
        mobileBtn?.setAttribute("aria-expanded", isOpen ? "false" : "true");
    });

    mobileLinks.forEach((link) => {
        link.addEventListener("click", () => {
            mobileMenu?.classList.add("translate-x-full");
            document.body.classList.remove("overflow-hidden");
        });
    });

    // Language dropdown
    langBtn?.addEventListener("click", (e) => {
        e.stopPropagation();
        langMenu?.classList.toggle("open");
        langChevron?.classList.toggle("open");
        const isExpanded = langMenu?.classList.contains("open");
        langBtn?.setAttribute("aria-expanded", isExpanded ? "true" : "false");
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", (e) => {
        const target = e.target as HTMLElement;
        if (!target.closest("#lang-dropdown")) {
            langMenu?.classList.remove("open");
            langChevron?.classList.remove("open");
            langBtn?.setAttribute("aria-expanded", "false");
        }
    });

    // Initial check
    updateHeader();
</script>
