services:
  # Servicio A: Web Corporativa
  web:
    build:
      context: ./cieasesoria-web
      dockerfile: Dockerfile
    container_name: cieasesoria-web
    restart: unless-stopped
    expose:
      - "4321"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.cieasesoria-web.rule=Host(`cieasesoria.com`) || Host(`www.cieasesoria.com`)"
      - "traefik.http.routers.cieasesoria-web.entrypoints=websecure"
      - "traefik.http.routers.cieasesoria-web.tls.certresolver=letsencrypt"
      - "traefik.http.routers.cieasesoria-web.middlewares=security-headers@docker"
      - "traefik.http.services.cieasesoria-web.loadbalancer.server.port=4321"
      - "traefik.http.routers.cieasesoria-web-http.rule=Host(`cieasesoria.com`) || Host(`www.cieasesoria.com`)"
      - "traefik.http.routers.cieasesoria-web-http.entrypoints=web"
      - "traefik.http.routers.cieasesoria-web-http.middlewares=redirect-to-https@file"
      # Security Headers Middleware
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.security-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.customResponseHeaders.Cross-Origin-Opener-Policy=same-origin"
      - "traefik.http.middlewares.security-headers.headers.contentSecurityPolicy=default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google.com https://www.gstatic.com https://www.googletagmanager.com https://www.recaptcha.net https://recaptcha.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://www.google.com https://www.google-analytics.com https://www.recaptcha.net; frame-src https://www.google.com https://www.recaptcha.net https://recaptcha.google.com; object-src 'none'; base-uri 'self'"
    environment:
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - CONTACT_EMAIL_TO=${CONTACT_EMAIL_TO:-cieasesoria@gmail.com}
      - PUBLIC_RECAPTCHA_SITE_KEY=${PUBLIC_RECAPTCHA_SITE_KEY}
      - RECAPTCHA_SECRET_KEY=${RECAPTCHA_SECRET_KEY}
    networks:
      - dokploy-network

  # Servicio B: Canal de Denuncias (GlobaLeaks)
  globaleaks:
    image: globaleaks/globaleaks:latest
    container_name: globaleaks
    restart: unless-stopped
    volumes:
      - globaleaks_data:/var/globaleaks
    environment:
      - GL_LETSENCRYPT_DISABLE=1
    expose:
      - "8443"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.globaleaks.rule=Host(`canaldenuncias.cieasesoria.com`)"
      - "traefik.http.routers.globaleaks.entrypoints=websecure"
      - "traefik.http.routers.globaleaks.tls.certresolver=letsencrypt"
      - "traefik.http.services.globaleaks.loadbalancer.server.port=8443"
      - "traefik.http.services.globaleaks.loadbalancer.server.scheme=https"
      - "traefik.http.services.globaleaks.loadbalancer.serversTransport=insecure@file"
    networks:
      - dokploy-network

  # Servicio C: CMS Database (PostgreSQL)
  cms-db:
    image: postgres:15-alpine
    container_name: cieasesoria-cms-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: directus
      POSTGRES_USER: directus
      POSTGRES_PASSWORD: directuspassword123
    volumes:
      - cms_db_data:/var/lib/postgresql/data
    networks:
      - dokploy-network

  # Servicio D: CMS Admin (Directus)
  directus:
    image: directus/directus:10
    container_name: cieasesoria-directus
    restart: unless-stopped
    environment:
      KEY: "cieasesoria-directus-key-123"
      SECRET: "cieasesoria-directus-secret-456"
      DB_CLIENT: pg
      DB_HOST: cms-db
      DB_PORT: 5432
      DB_DATABASE: directus
      DB_USER: directus
      DB_PASSWORD: directuspassword123
      ADMIN_EMAIL: "admin@cieasesoria.com"
      ADMIN_PASSWORD: "CieAdmin2024!"
      PUBLIC_URL: "https://zeion.cieasesoria.com"
    volumes:
      - directus_uploads:/directus/uploads
    expose:
      - "8055"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.directus.rule=Host(`zeion.cieasesoria.com`)"
      - "traefik.http.routers.directus.entrypoints=websecure"
      - "traefik.http.routers.directus.tls.certresolver=letsencrypt"
      - "traefik.http.services.directus.loadbalancer.server.port=8055"
    depends_on:
      - cms-db
    networks:
      - dokploy-network

volumes:
  globaleaks_data:
  cms_db_data:
  directus_uploads:


networks:
  dokploy-network:
    external: true
