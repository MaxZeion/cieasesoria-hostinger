services:
  # Servicio A: Web Corporativa
  web:
    build:
      context: ./cieasesoria-web
      dockerfile: Dockerfile
    container_name: cieasesoria-web
    restart: unless-stopped
    expose:
      - "80"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.cieasesoria-web.rule=Host(`cieasesoria.com`) || Host(`www.cieasesoria.com`)"
      - "traefik.http.routers.cieasesoria-web.entrypoints=websecure"
      - "traefik.http.routers.cieasesoria-web.tls.certresolver=letsencrypt"
      - "traefik.http.services.cieasesoria-web.loadbalancer.server.port=80"
      - "traefik.http.routers.cieasesoria-web-http.rule=Host(`cieasesoria.com`) || Host(`www.cieasesoria.com`)"
      - "traefik.http.routers.cieasesoria-web-http.entrypoints=web"
      - "traefik.http.routers.cieasesoria-web-http.middlewares=redirect-to-https@file"
    networks:
      - dokploy-network

  # Servicio B: Canal de Denuncias (GlobaLeaks)
  globaleaks:
    image: globaleaks/globaleaks:latest
    container_name: globaleaks
    restart: unless-stopped
    volumes:
      - globaleaks_data:/var/globaleaks
    environment:
      - GL_LETSENCRYPT_DISABLE=1
    expose:
      - "8443"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.globaleaks.rule=Host(`canaldenuncias.cieasesoria.com`)"
      - "traefik.http.routers.globaleaks.entrypoints=websecure"
      - "traefik.http.routers.globaleaks.tls.certresolver=letsencrypt"
      - "traefik.http.services.globaleaks.loadbalancer.server.port=8443"
      - "traefik.http.services.globaleaks.loadbalancer.server.scheme=https"
      - "traefik.http.services.globaleaks.loadbalancer.serversTransport=insecure@file"
    networks:
      - dokploy-network

  # Servicio C: CMS Database (PostgreSQL)
  strapi-db:
    image: postgres:15-alpine
    container_name: cieasesoria-strapi-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=strapi
      - POSTGRES_USER=strapi
      - POSTGRES_PASSWORD=strapipassword123
    volumes:
      - strapi_db_data:/var/lib/postgresql/data
    networks:
      - dokploy-network

  # Servicio D: CMS Admin (Strapi)
  strapi:
    image: strapi/strapi:latest
    container_name: cieasesoria-strapi
    restart: unless-stopped
    environment:
      - DATABASE_CLIENT=postgres
      - DATABASE_HOST=strapi-db
      - DATABASE_PORT=5432
      - DATABASE_NAME=strapi
      - DATABASE_USERNAME=strapi
      - DATABASE_PASSWORD=strapipassword123
      - NODE_ENV=production
      - APP_KEYS=toBeModified1,toBeModified2,toBeModified3,toBeModified4
      - API_TOKEN_SALT=toBeModifiedApiTokenSalt
      - ADMIN_JWT_SECRET=toBeModifiedAdminJwtSecret
      - JWT_SECRET=toBeModifiedJwtSecret
    volumes:
      - strapi_data:/srv/app
    expose:
      - "1337"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      - "traefik.http.routers.strapi.rule=Host(`zeion.cieasesoria.com`)"
      - "traefik.http.routers.strapi.entrypoints=websecure"
      - "traefik.http.routers.strapi.tls.certresolver=letsencrypt"
      - "traefik.http.services.strapi.loadbalancer.server.port=1337"
    depends_on:
      - strapi-db
    networks:
      - dokploy-network

volumes:
  globaleaks_data:
  strapi_db_data:
  strapi_data:


networks:
  dokploy-network:
    external: true
